# Calibration for the IMU Magnetometer

When calibrating we want to be performing it several feet away from high magnetic interferers like tables with magnetic components, desktop PC towers, monitors, etc.
If this guideline is not followed then the magnetometer calibration will include the compensations for those environmental interferers.

This is also why we have to recalibrate so frequently, as the interfering factors can change so often and we want the best performance during operation. Hence why we need to recalibrate often.

**IMPORTANT**: The robot orientation values (heading, roll, pitch) will shift after the robot moves because of the Magnetic interference generated by the robot's motors. The impact is manageable (and we are mostly concerned about the *heading*) and with the nature of the DMP auto adjusting it's calibration from interfering factors the values by slowly stabilising.
(An example of the error would be the heading is ~10 degrees off from the heading to North after the robot drove forwards)

## Page Navigation

- [Calibration for the IMU Magnetometer](#calibration-for-the-imu-magnetometer)
  - [Page Navigation](#page-navigation)
  - [Steps for Calibrating the ICM-20948's DMP and the BNO085's MotionEngine](#steps-for-calibrating-the-icm-20948s-dmp-and-the-bno085s-motionengine)
    - [Steps](#steps)
  - [Manual Calibration for the IMU Magnetometer (for Non-DMP implementations)](#manual-calibration-for-the-imu-magnetometer-for-non-dmp-implementations)
  - [Calibration accuracy](#calibration-accuracy)

## Steps for Calibrating the ICM-20948's DMP and the BNO085's MotionEngine

In order to use the ICM-20948's DMP (via the [Sparkfun library](https://github.com/sparkfun/SparkFun_ICM-20948_ArduinoLibrary)) we need to calibrate the DMP so that the reading become stable.
This allows the DMP to measure the 'scale' and 'offset' for each sensor channel.
To do this we follow these [steps](https://cdn.sparkfun.com/assets/9/e/1/d/9/Sensor-Calibration-Procedure-v1.1.pdf).
These are similar for the BNO085 sensor which the robot is also equipped with and also needs to be calibrated before the robot can be used.

### Steps

1. First we do the accelerometers calibration actions/motions by moving the robots into 4-6 unique orientations for at least 1 sec (or more) a each. You can use the "cube" method described in those [steps](https://cdn.sparkfun.com/assets/9/e/1/d/9/Sensor-Calibration-Procedure-v1.1.pdf):
    ![cube method (a)](img/Calibration/Cube%20Method%20(a).PNG)
    ![cube method (b)](img/Calibration/Cube%20Method%20(b).PNG)
    1.1.  The Positions don't necessarily need to be perfect aligned with each face and is only a way of visualising the motions because it's more important to have the 4-6 unique orientations.
2. Next we calibrate the gyroscope by leaving the robot stationary on the operating surface for at least 2-3 seconds.
3. Finally, the magnetometer calibration motions are similar to the [steps](https://cdn.sparkfun.com/assets/9/e/1/d/9/Sensor-Calibration-Procedure-v1.1.pdf), with some additional detail based on our preferences:
    ![Mag Calibration Rotation](img/Calibration/Cal%20Rotations.PNG)
    3.1. The extra things we'd like to point out is that when the rotation around an axis we want to rotate around the whole 360 degrees of the axis, and this can be done via these two methods (as it a can be challenging to rotate the robot whole rotation/movement):  
    ![Additional Mag Cal Rotation steps](img/Calibration/Prefered%20Rotation%20Method.PNG)

    3.2. The rotation around each axis should take at least 2 seconds (but this doesn't need to be exact)
    3.3. The more rotations done the better the result (2 is a good minimum)

## Manual Calibration for the IMU Magnetometer (for Non-DMP implementations)

**Disclaimer:** This method is not used within the final implementation of the robot and instead favours the use of the IMU's DMP and MotionEngine features because of their acceptable accuracy, ease of use and the benefits there offer to speed up our development and testing workflow. As a result the documentation for this approach is not as in depth as other parts and can't be guaranteed to work later on should anything change with the robot's system/configuration.

Calibrating the magnetometer to reduce error in the sensor reading for soft and hard iron source near by (and on) the robot can be done manually and can be used for the ICM-20948 if using an older version of the microcontroller software ([here](/Microcontroller/Robot%20Sensor%20Motor%20Controller/))

If you want to perform manual calibration then you can do so by following this [guide](https://learn.adafruit.com/how-to-fuse-motion-sensor-data-into-ahrs-orientation-euler-quaternions?view=all) to setup the reading and writing of the calibration data and using the calibration read and write project [here](Microcontroller/IMU%20Calibration/) for get the calibration data and write it into EEPROM.

Additonally, you have to make sure that within [RobotConfig.h](Microcontroller/Robot%20Sensor%20Motor%20Controller/src/Robot/RobotConfig.h) you have `IMU_CAL_VIA_SERIAL` as `false` and `IMU::setupIMU(float _sampleFrequency, bool load_cal_from_EEPROM)` was `load_cal_from_EEPROM` as `true` if we are loading the written calibration values from the EEPROM in the firmware's [main file](Microcontroller/Robot%20Sensor%20Motor%20Controller/src/main.cpp).

if, instead, you put the calibration values in [RobotConfig.h](Microcontroller/Robot%20Sensor%20Motor%20Controller/src/Robot/RobotConfig.h) then set was `load_cal_from_EEPROM` as `true` for the function call of `IMU::setupIMU(float _sampleFrequency, bool load_cal_from_EEPROM)` in the firmware's [main file](Microcontroller/Robot%20Sensor%20Motor%20Controller/src/main.cpp).

## Calibration accuracy

Confirming the calibration quality can be tricky but you can verify that the robot's calibration's accuracy by comparing the offset in the robot's heading when the robot is facing north. Having the heading as close to 0 when facing north is the best case scenario but getting a perfectly accurate result is challenging as many things in the surrounding environment can cause interference in the IMU's sensor readings, particularly the magnetometer because it's reliance on magnetic field which can be manipulated/distorted due to surrounding objects and also any externally generated magnetic field that object in the environment could be generating (or even the robot it self).
